pipeline {
    agent any
    
    parameters {
        booleanParam(name: 'MANUAL_TRIGGER', defaultValue: false, description: 'Trigger the build manually')
    }
    
    triggers {
        pollSCM('H/5 * * * *') // Poll SCM every 5 minutes for changes
        cron('H 0 * * *') // Run the Pull & Test stage every hour
    }
    
    stages {
        stage('Build & Deploy') {
            when {
                anyOf {
                    changeRequest target: 'main' // Trigger on pull request to the main branch
                    expression { params.MANUAL_TRIGGER == true } // Trigger manually from Jenkins UI
                }
            }
            steps {
                script {
                    // Clone the Git repository and checkout the relevant PR branch
                    checkout scm
                    
                    // Build the Docker image
                    def dockerImage = docker.build("your-ecr-repo/python-script:${env.BUILD_NUMBER}")
                    
                    // Run the Python script inside the Docker container
                    dockerImage.inside {
                        sh 'python task.py'
                    }
                    
                    // Deploy the artifact to S3
                    withAWS(credentials: 'your-aws-credentials', region: 'us-east-1') {
                        s3Upload(file: 'artifact-latest.txt', bucket: 'your-s3-bucket', path: 'artifacts/')
                    }
                    
                    // Deploy the Docker image to ECR
                    docker.withRegistry('https://your-ecr-repo.amazonaws.com', 'ecr:us-east-1:your-ecr-credentials') {
                        dockerImage.push("${env.BUILD_NUMBER}")
                        dockerImage.push("latest")
                    }
                }
            }
        }
        
        stage('Pull & Test') {
            when {
                anyOf {
                    triggeredBy 'TimerTrigger' // Trigger periodically based on the cron schedule
                    expression { params.MANUAL_TRIGGER == true } // Trigger manually from Jenkins UI
                }
            }
            steps {
                script {
                    // Download the most recent artifact from S3
                    withAWS(credentials: 'your-aws-credentials', region: 'us-east-1') {
                        s3Download(file: 'artifact-latest.txt', bucket: 'your-s3-bucket', path: 'artifacts/artifact-latest.txt', force: true)
                    }
                    
                    // Test whether the artifact is empty
                    def artifactContent = readFile('artifact-latest.txt').trim()
                    if (artifactContent.isEmpty()) {
                        echo 'Artifact is empty'
                    } else {
                        echo 'Artifact is not empty'
                        echo "Artifact content:\n${artifactContent}"
                    }
                }
            }
        }
    }
}